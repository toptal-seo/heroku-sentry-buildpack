#!/usr/bin/env bash

BUILD_DIR=$1
CACHE_DIR=${2:-}
ENV_DIR=${3:-}
BP_DIR=$(cd "$(dirname "${0:-}")"; cd ..; pwd)

export SENTRY_ENVIRONMENT=$(cat $ENV_DIR/ENVIRONMENT_NAME);

echo "-----> Running Sentry Buildpack (Env: $SENTRY_ENVIRONMENT)"
# Install Sentry CLI
mkdir -p "$BUILD_DIR/vendor/bin"
SENTRY_URL_INFO=$(curl -sL https://sentry.io/get-cli/ | grep SENTRY_DOWNLOAD_Linux_x86_64)
echo "Gotten recent url info: $SENTRY_URL_INFO"
SENTRY_VERSION=${SENTRY_URL_INFO:74:6}
SENTRY_URL=${SENTRY_URL_INFO:30:-1}
echo "-----> Downloading modern Sentry: $SENTRY_URL, version: $SENTRY_VERSION"
curl -L -o "$CACHE_DIR/sentry-cli-$SENTRY_VERSION" "$SENTRY_URL"
ls -al "$CACHE_DIR"
cp "$CACHE_DIR/sentry-cli-$SENTRY_VERSION" "$BUILD_DIR/vendor/bin/sentry-cli"
chmod a+x "$BUILD_DIR/vendor/bin/sentry-cli"

# Setting environment variables in .profile.d script (sourced at dyno startup)
echo "-----> Setting Environment Variables"
mkdir -p "$BUILD_DIR/.profile.d"
cp "$BP_DIR"/profile/* "$BUILD_DIR/.profile.d/"
echo "-----> Done"
exit 0
